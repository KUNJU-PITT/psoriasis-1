---
title: "Cogena on GSE30999"
author: "Zhilong Jia et al."
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    # css: custom.css
    toc: yes
    toc_depth: 2

vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} %\usepackage[utf8]{inputenc}
---

***

# Introduction

This report reproduces all the results related with GSE30999. An online
verison can be found at https://github.com/zhilongjia/psoriasis

```{r opts_chunk, echo=FALSE, results="hide"}
knitr::opts_chunk$set(cache=TRUE, cache.path="../tmp/", 
                      fig.width=10, fig.height=10, fig.path="../tmp/")
```
# Data Preparation

## Check package required
```{r requirement}
# Check package required
packages <- c("knitr", "GEOquery", "MetaDE", "annotate", "hgu133plus2.db", 
              "affy", "limma", "STRINGdb", "hgu133plus2.db", "devtools", "cogena")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
    stop(paste("Please install packages:", setdiff(packages, rownames(installed.packages()))) )
}
```

## Download the raw data of [GSE30999](http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE30999)
```{r data}
# Download raw files from GEO and untar them if nothing in ../data/GSE30999_RAW
if (length(dir("../data/GSE30999_RAW", all.files=FALSE)) ==0) {
    
    download.file("http://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE30999&format=file",
              destfile="../data/GSE30999_RAW.tar")
    untar("../data/GSE30999_RAW.tar", exdir="../data/GSE30999_RAW")
    file.remove("../data/GSE30999_RAW.tar")
}

```

## Differential Expression Analysis

```{r DEA, message=FALSE}
library(GEOquery)
library(affy)

################################################################################
# Download raw data of GSE30999
GSE30999raw <- ReadAffy(celfile.path="../data/GSE30999_RAW")
sampleNames(GSE30999raw) <- sub("(_|\\.).*CEL\\.gz","", sampleNames(GSE30999raw))

################################################################################
# Sample Label preprocessing
GSE30999series <- getGEO("GSE30999", destdir="../data")
GSE30999label <- pData(GSE30999series$GSE30999_series_matrix.txt.gz)[,c("title", "geo_accession")]
GSE30999label$title <- as.character(GSE30999label$title)

GSE30999label[grep("NL", GSE30999label$title),"state"] = "ct"
GSE30999label[grep("LS", GSE30999label$title),"state"] = "Psoriasis"
GSE30999label$state <- factor(GSE30999label$state, levels=c("ct", "Psoriasis"))
GSE30999label[,"gse_id"] = "GSE30999"
GSE30999label$rep <- sapply(strsplit(GSE30999label$title, "_"), "[", 1)


vmd = data.frame(labelDescription = c("title", "geo_accession", "state", "gse_id", "rep"))
phenoData(GSE30999raw) = new("AnnotatedDataFrame", data = GSE30999label, varMetadata = vmd)
pData(protocolData(GSE30999raw)) <- 
    pData(protocolData(GSE30999raw))[rownames(GSE30999label),,drop=FALSE]

# RMA normalization
GSE30999rma <- rma(GSE30999raw)

################################################################################
# Filter the non-informative and non-expressed genes. 
library(MetaDE)
library(annotate)
library(hgu133plus2.db)

GSE30999.Explist <- list(GSE30999=list(x = exprs(GSE30999rma), 
                         y = ifelse (GSE30999label$state=="ct", 0, 1), 
                         symbol = getSYMBOL(rownames(exprs(GSE30999rma)), "hgu133plus2") ))
GSE30999.Explist <- MetaDE.match(GSE30999.Explist, pool.replicate="IQR")
GSE30999.Explist.filtered <- MetaDE.filter(GSE30999.Explist, c(0.2,0.2))
colnames(GSE30999.Explist.filtered$GSE30999$x) <- colnames(exprs(GSE30999rma))

################################################################################
# DEG analysis via limma
DElimma <- function (Expdata, Explabel){
    
    library(limma)
    Expdesign <- model.matrix(~as.factor(Explabel$rep) + Explabel$state)
    Expfit1 <- lmFit(Expdata, Expdesign)
    Expfit2 <- eBayes(Expfit1)
    dif_Exp <- topTable(Expfit2, coef=tail(colnames(Expdesign), 1), number=Inf)
    
    return (dif_Exp)
}

GSE30999.limma <- DElimma(GSE30999.Explist.filtered$GSE30999$x, GSE30999label)
GSE30999.DE <- GSE30999.limma[GSE30999.limma$adj.P.Val<=0.05 & abs(GSE30999.limma$logFC)>=1,]
GSE30999.DEG <- rownames(GSE30999.DE)
GSE30999.DEG.expr <- GSE30999.Explist.filtered$GSE30999$x[GSE30999.DEG,]

```

# Co-expression Analysis by cogena
```{r coexpression, message=FALSE}
# Install cogena if none
library(cogena)
if (packageVersion("cogena") < "1.2.0") {
    devtools::install_github("zhilongjia/cogena")
}
# Parameters for funtion coExp
nClust <- 11 # 11 clusters
clMethods <- c("pam") # pam clustering method
# nClust <- 2:20
# clMethods <- c("hierarchical","kmeans","diana","fanny","som","sota","pam","clara","agnes")
ncore <- 7 # 7 cores

################################################################################
# Co-expression analysis
# "correlation" is used for the distance caculation, "complete" is used for
# the agglomeration (for hclust and agnes clustering methods only).
genecl_result <- coExp(GSE30999.DEG.expr, nClust=nClust, clMethods=clMethods, 
                       metric="correlation", method="complete", ncore=ncore, 
                       verbose=FALSE)
```

# Pathway Analysis by cogena
```{r pathway, message=FALSE}
# Parameters for funtion clEnrich
annoGMT <- "c2.cp.kegg.v5.0.symbols.gmt.xz" # kegg pathway gene set
annofile <- system.file("extdata", annoGMT, package="cogena")
sampleLabel <- GSE30999label$state
names(sampleLabel) <- rownames(GSE30999label)

################################################################################
# cogena analysis (Pathway analysis)
cogena_result <- clEnrich(genecl_result, annofile=annofile, sampleLabel=sampleLabel)

# Summary the results obtained by cogena
summary(cogena_result)

```

## Heatmap with co-expressed genes
```{r figure1, fig.cap="Heatmap with co-expression information"}
# Figure 1
heatmapCluster(cogena_result, "pam", "11", maintitle="Psoriasis (GSE30999)")
```

## Table : Co-expressed genes are highly connected
```{r ppi, message=FALSE}
# pPPI function: get the PPI summary information about input genes
pPPI <- function(geneC, string_db){
    example1_mapped <- string_db$map(as.data.frame(geneC), "geneC", 
                                     removeUnmappedRows = TRUE, quiet=TRUE)
    hits <- example1_mapped$STRING_id
    net_summary <- string_db$get_summary(unique(hits))
    as.numeric( gsub("[^1:9]+\\: |\\)", "", strsplit(net_summary, "\n|\\(")[[1]] ) )
}
# Init table
cluster_ppi <- data.frame(protein=numeric(14), interactions=numeric(14),
                             expected_interactions=numeric(14),
                             p_value=numeric(14), stringsAsFactors=FALSE)
rownames(cluster_ppi) <- c(1:11, "Up", "Down", "All_DE")

# Get PPI information for each cluster. 
library(STRINGdb)
suppressWarnings(string_db <- STRINGdb$new(version="10", species=9606, 
                                           score_threshold=400, 
                                           input_directory="../tmp"))
for (i in 1:11) {
    i <- as.character(i)
    cluster_ppi[i,] <- pPPI(geneInCluster(cogena_result, "pam", "11", i), string_db)
}
cluster_ppi["Up",] <- pPPI(rownames(GSE30999.DE[GSE30999.DE$logFC>0,]), string_db)
cluster_ppi["Down",] <- pPPI(rownames(GSE30999.DE[GSE30999.DE$logFC<0,]), string_db)
cluster_ppi["All_DE",] <- pPPI(rownames(GSE30999.DE), string_db)
cluster_ppi$ratio <- cluster_ppi$interactions / cluster_ppi$expected_interactions

# Table 1
knitr::kable(cluster_ppi, caption="Summary of interactions within clusters")
```

## Figure : The result of pathway analysis
```{r figure2, fig.width=12, fig.height=10, cache=TRUE, fig.cap="Pathway Analysis"}
# Figure 2
heatmapPEI(cogena_result, "pam", "11", printGS=FALSE, maintitle="Psoriasis (GSE30999)")
```

## GSEA

This is to get the GSEA results. The result can be obtained from *result/GSEA_output*.
See [gct](http://www.broadinstitute.org/cancer/software/genepattern/file-formats-guide#GCT)
and [cls](http://www.broadinstitute.org/cancer/software/genepattern/file-formats-guide#CLS) 
file format if needed.

```{r gsea, warning=TRUE, eval=FALSE}
# Prepare inputs for GSEA
expData <- as.data.frame(exprs(GSE30999rma))
expData$DESCRIPTION <- NA
expData <- expData[,c("DESCRIPTION", colnames(expData)[1:170])]

################################################################################

# Generate gct file
write.table(expData, file="../result/GSEA_input/GSE30999_exp.gct", sep="\t", quote=FALSE)
# Add the following 3 lines at the begining of GSE30999_exp.gct
fConn <- file('../result/GSEA_input/GSE30999_exp.gct', 'r+')
Lines <- sub("DESCRIPTION", "NAME\tDESCRIPTION", readLines(fConn))
writeLines(c("#1.2\n54675\t170", Lines ), con = fConn)
close(fConn)

################################################################################

# Generate cls file
write.table(t(as.character(GSE30999label$state)), file="../result/GSEA_input/GSE30999.cls",quote=FALSE, col.names=FALSE, row.names=FALSE)
fConn1 <- file('../result/GSEA_input/GSE30999.cls', 'r+') 
writeLines(c("170 2 1\n#ct Psoriasis", readLines(fConn1) ), con = fConn1)
close(fConn1) 

################################################################################

# GSEA analysis
if (isTRUE(system("which java", intern=FALSE)==0) & file.exists("gsea2-2.1.0.jar")) {
    system(command="java -cp ./gsea2-2.1.0.jar -Xmx512m xtools.gsea.Gsea -res ../result/GSEA_input/GSE30999_exp.gct -cls ../result/GSEA_input/GSE30999.cls -gmx ../result/GSEA_input/c2.cp.kegg.v5.0.symbols.gmt -collapse true -mode Max_probe -norm meandiv -nperm 1000 -permute phenotype -rnd_type no_balance -scoring_scheme weighted -rpt_label GSE30999 -metric Signal2Noise -sort real -order descending -chip ../result/GSEA_input/HG_U133_Plus_2.chip -include_only_symbols true -make_sets false -median false -num 100 -plot_top_x 20 -rnd_seed 149 -save_rnd_lists false -set_max 500 -set_min 15 -zip_report false -out ../result/GSEA_output -gui false")
} else {
    warning("Java is not found! GSEA was not run.")
}
#Show the gsea code above
# java -cp ./gsea2-2.1.0.jar -Xmx512m xtools.gsea.Gsea 
# -res ../result/GSEA_input/GSE30999_exp.gct -cls ../result/GSEA_input/GSE30999.cls 
# -gmx ../result/GSEA_input/c2.cp.kegg.v5.0.symbols.gmt 
# -collapse true -mode Max_probe -norm meandiv -nperm 1000 -permute phenotype 
# -rnd_type no_balance -scoring_scheme weighted -rpt_label GSE30999 
# -metric Signal2Noise -sort real -order descending 
# -chip ../result/GSEA_input/HG_U133_Plus_2.chip -include_only_symbols true 
# -make_sets false -median false -num 100 -plot_top_x 20 -rnd_seed 149 
# -save_rnd_lists false -set_max 500 -set_min 15 -zip_report false 
# -out ../result/GSEA_output -gui false
```


# Drug repositioning by cogena
```{r drp}
# Drug repositioning based on CmapDn100 gene set
cmapDn100_cogena_result <- clEnrich_one(genecl_result, "pam", "11", 
        annofile=system.file("extdata", "CmapDn100.gmt.xz", package="cogena"), 
        sampleLabel=sampleLabel)

# Drug repositioning based on CmapUp100 gene set
cmapUp100_cogena_result <- clEnrich_one(genecl_result, method="pam", nCluster="11",
        annofile=system.file("extdata", "CmapUp100.gmt.xz", package="cogena"), 
        sampleLabel=sampleLabel)

```

## Figure : Drug repositioning for cluster 1
```{r Figure3, fig.cap="Drug Repositioning for cluster 1"}
# Figure 3
heatmapPEI(cmapDn100_cogena_result, "pam", "11", printGS=FALSE, 
           orderMethod = "1", maintitle="Psoriasis (GSE30999)")
```

## Figure : Drug repositioning for cluster 4
```{r Figure4, fig.cap="Drug Repositioning for cluster 4"}
# Figure 4
heatmapPEI(cmapDn100_cogena_result, "pam", "11", printGS=FALSE, 
           orderMethod = "4", maintitle="Psoriasis (GSE30999)")

```

## Figure : Drug repositioning for cluster 5
```{r FigureS1, fig.cap="Drug Repositioning for cluster 5"}
# Figure 5
heatmapPEI(cmapDn100_cogena_result, "pam", "11", printGS=FALSE, 
           orderMethod = "5", maintitle="Psoriasis (GSE30999)")

```

## Figure : Drug repositioning for cluster 10
```{r FigureS2, fig.cap="Drug Repositioning for cluster 10"}
# Figure 6
heatmapPEI(cmapUp100_cogena_result, "pam", "11", printGS=FALSE, 
           orderMethod = "10", maintitle="Psoriasis (GSE30999)")

```


## Output DEGs for CMAP and NFFinder Analysis

The input files for CMap and NFFinder , outputed by this chunk, are in *result/CMAP_input/* and
 *result/NFFinder_input/* respectively.
Please visit [CMap](http://www.connectivitymap.org/cmap/) and
[NFFinder](http://nffinder.cnb.csic.es/) to get the final 
results (*Table S2*) by yourself. Or you can find the results in 
*result/CMAP_output/* and
 *result/NFFinder_output/* respectively

```{r deg_drp, message=TRUE, eval=FALSE}
# Convert gene symbols to probes in HGU133a.
symbol2Probe <- function(gs){
    library(hgu133a.db)
    p <- AnnotationDbi::select(hgu133a.db, gs, "PROBEID", "SYMBOL")$PROBEID
    p <- unique(p[which(!is.na(p))])
}

upGene <- rownames(GSE30999.limma[GSE30999.limma$logFC>= 1 & GSE30999.limma$adj.P.Val<=0.05,])
dnGene <- rownames(GSE30999.limma[GSE30999.limma$logFC<= -1 & GSE30999.limma$adj.P.Val<=0.05,])
upProbe <- symbol2Probe(upGene)
dnProbe <- symbol2Probe(dnGene)

# 1000 probe limitation of CMap
upProbe <- upProbe[1:(1000-length(dnProbe))]

################################################################################
# Output files for CMap and NFFinder
write.table(upProbe, file=paste0("../result/CMAP_input/", "GSE30999_Up.grp"), 
            quote=F, col.names = F, row.names = F)
write.table(dnProbe, file=paste0("../result/CMAP_input/", "GSE30999_Dn.grp"), 
            quote=F, col.names = F, row.names = F)
write.table(upGene, file=paste0("../result/NFFinder_input/", "GSE30999_Up.txt"), 
            quote=F, col.names = F, row.names = F)
write.table(dnGene, file=paste0("../result/NFFinder_input/", "GSE30999_Dn.txt"), 
            quote=F, col.names = F, row.names = F)
################################################################################

save.image(file="../result/cogena_GSE30999.RData")
################################################################################
```

# Website, BugReports and System Info

* Website: https://github.com/zhilongjia/psoriasis
* BugReports: https://github.com/zhilongjia/psoriasis/issues

```{r sessionInfo}
sessionInfo()
```

Thank you!

***


